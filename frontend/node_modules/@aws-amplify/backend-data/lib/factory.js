import { AmplifyData, AmplifyDynamoDbTableWrapper, } from '@aws-amplify/data-construct';
import * as path from 'path';
import { combineCDKSchemas, convertSchemaToCDK, isCombinedSchema, isDataSchema, } from './convert_schema.js';
import { convertFunctionNameMapToCDK } from './convert_functions.js';
import { buildConstructFactoryProvidedAuthConfig, convertAuthorizationModesToCDK, isUsingDefaultApiKeyAuth, } from './convert_authorization_modes.js';
import { validateAuthorizationModes } from './validate_authorization_modes.js';
import { AmplifyError, AmplifyUserError, CDKContextKey, TagName, } from '@aws-amplify/platform-core';
import { Aspects, Tags } from 'aws-cdk-lib';
import { convertJsResolverDefinition } from './convert_js_resolvers.js';
import { AppSyncPolicyGenerator } from './app_sync_policy_generator.js';
/**
 * Singleton factory for AmplifyGraphqlApi constructs that can be used in Amplify project files.
 *
 * Exported for testing purpose only & should NOT be exported out of the package.
 */
export class DataFactory {
    props;
    importStack;
    // publicly accessible for testing purpose only.
    static factoryCount = 0;
    generator;
    /**
     * Create a new AmplifyConstruct
     */
    constructor(props, importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
        if (DataFactory.factoryCount > 0) {
            throw new AmplifyUserError('MultipleSingletonResourcesError', {
                message: 'Multiple `defineData` calls are not allowed within an Amplify backend',
                resolution: 'Remove all but one `defineData` call',
            });
        }
        DataFactory.factoryCount++;
    }
    /**
     * Gets an instance of the Data construct
     */
    getInstance = (props) => {
        const { constructContainer, outputStorageStrategy, importPathVerifier, resourceNameValidator, } = props;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'data', 'resource'), 'Amplify Data must be defined in amplify/data/resource.ts');
        if (this.props.name) {
            resourceNameValidator?.validate(this.props.name);
        }
        if (!this.generator) {
            this.generator = new DataGenerator(this.props, buildConstructFactoryProvidedAuthConfig(props.constructContainer
                .getConstructFactory('AuthResources')
                ?.getInstance(props)), props, outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class DataGenerator {
    props;
    providedAuthConfig;
    getInstanceProps;
    outputStorageStrategy;
    resourceGroupName = 'data';
    name;
    constructor(props, providedAuthConfig, getInstanceProps, outputStorageStrategy) {
        this.props = props;
        this.providedAuthConfig = providedAuthConfig;
        this.getInstanceProps = getInstanceProps;
        this.outputStorageStrategy = outputStorageStrategy;
        this.name = props.name ?? 'amplifyData';
    }
    generateContainerEntry = ({ scope, ssmEnvironmentEntriesGenerator, backendSecretResolver, stableBackendIdentifiers, }) => {
        const amplifyGraphqlDefinitions = [];
        const schemasJsFunctions = [];
        const schemasFunctionSchemaAccess = [];
        let schemasLambdaFunctions = {};
        try {
            const schemas = isCombinedSchema(this.props.schema)
                ? this.props.schema.schemas
                : [this.props.schema];
            schemas.forEach((schema) => {
                if (isDataSchema(schema)) {
                    const { jsFunctions, functionSchemaAccess, lambdaFunctions } = schema.transform();
                    schemasJsFunctions.push(...jsFunctions);
                    schemasFunctionSchemaAccess.push(...functionSchemaAccess);
                    schemasLambdaFunctions = {
                        ...schemasLambdaFunctions,
                        ...lambdaFunctions,
                    };
                }
                amplifyGraphqlDefinitions.push(convertSchemaToCDK(schema, backendSecretResolver, stableBackendIdentifiers));
            });
        }
        catch (error) {
            throw new AmplifyUserError('InvalidSchemaError', {
                message: error instanceof Error
                    ? error.message
                    : 'Failed to parse schema definition.',
                resolution: 'Check your data schema definition for syntax and type errors.',
            }, error instanceof Error ? error : undefined);
        }
        let authorizationModes;
        try {
            authorizationModes = convertAuthorizationModesToCDK(this.getInstanceProps, this.providedAuthConfig, this.props.authorizationModes);
        }
        catch (error) {
            if (AmplifyError.isAmplifyError(error)) {
                throw error;
            }
            throw new AmplifyUserError('InvalidSchemaAuthError', {
                message: error instanceof Error
                    ? error.message
                    : 'Failed to parse authorization modes.',
                resolution: 'Ensure the auth rules on your schema are valid.',
            }, error instanceof Error ? error : undefined);
        }
        try {
            validateAuthorizationModes(this.props.authorizationModes, authorizationModes);
        }
        catch (error) {
            throw new AmplifyUserError('InvalidSchemaAuthError', {
                message: error instanceof Error
                    ? error.message
                    : 'Failed to validate authorization modes',
                resolution: 'Ensure the auth rules on your schema are valid.',
            }, error instanceof Error ? error : undefined);
        }
        const sandboxModeEnabled = isUsingDefaultApiKeyAuth(this.providedAuthConfig, this.props.authorizationModes);
        const propsFunctions = this.props.functions ?? {};
        const functionNameMap = convertFunctionNameMapToCDK(this.getInstanceProps, {
            ...propsFunctions,
            ...schemasLambdaFunctions,
        });
        let amplifyApi = undefined;
        const isSandboxDeployment = scope.node.tryGetContext(CDKContextKey.DEPLOYMENT_TYPE) === 'sandbox';
        try {
            amplifyApi = new AmplifyData(scope, this.name, {
                apiName: this.name,
                definition: combineCDKSchemas(amplifyGraphqlDefinitions),
                authorizationModes,
                outputStorageStrategy: this.outputStorageStrategy,
                functionNameMap,
                translationBehavior: {
                    sandboxModeEnabled,
                    /**
                     * The destructive updates should be always allowed in backend definition and not to be controlled on the IaC
                     * The CI/CD check should take the responsibility to validate if any tables are being replaced and determine whether to execute the changeset
                     */
                    allowDestructiveGraphqlSchemaUpdates: true,
                    _provisionHotswapFriendlyResources: isSandboxDeployment,
                },
            });
        }
        catch (error) {
            throw new AmplifyUserError('AmplifyDataConstructInitializationError', {
                message: 'Failed to instantiate data construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(amplifyApi).add(TagName.FRIENDLY_NAME, this.name);
        /**;
         * Enable the table replacement upon GSI update
         * This is allowed in sandbox mode ONLY
         */
        if (isSandboxDeployment) {
            Aspects.of(amplifyApi).add(new ReplaceTableUponGsiUpdateOverrideAspect());
        }
        convertJsResolverDefinition(scope, amplifyApi, schemasJsFunctions);
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.name}_GRAPHQL_ENDPOINT`]: amplifyApi.resources.cfnResources.cfnGraphqlApi.attrGraphQlUrl,
        });
        const policyGenerator = new AppSyncPolicyGenerator(amplifyApi.resources.graphqlApi);
        schemasFunctionSchemaAccess.forEach((accessDefinition) => {
            const policy = policyGenerator.generateGraphqlAccessPolicy(accessDefinition.actions);
            accessDefinition.resourceProvider
                .getInstance(this.getInstanceProps)
                .getResourceAccessAcceptor()
                .acceptResourceAccess(policy, ssmEnvironmentEntries);
        });
        return amplifyApi;
    };
}
const REPLACE_TABLE_UPON_GSI_UPDATE_ATTRIBUTE_NAME = 'replaceTableUponGsiUpdate';
/**
 * Aspect class to modify the amplify managed DynamoDB table
 * to allow table replacement upon GSI update
 */
class ReplaceTableUponGsiUpdateOverrideAspect {
    visit(scope) {
        if (AmplifyDynamoDbTableWrapper.isAmplifyDynamoDbTableResource(scope)) {
            // These value setters are not exposed in the wrapper
            // Need to use the property override to escape the hatch
            scope.addPropertyOverride(REPLACE_TABLE_UPON_GSI_UPDATE_ATTRIBUTE_NAME, true);
        }
    }
}
/**
 * Creates a factory that implements ConstructFactory<AmplifyGraphqlApi>
 */
export const defineData = (props) => new DataFactory(props, new Error().stack);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVdBLE9BQU8sRUFDTCxXQUFXLEVBQ1gsMkJBQTJCLEdBRzVCLE1BQU0sNkJBQTZCLENBQUM7QUFFckMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFFN0IsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixrQkFBa0IsRUFDbEIsZ0JBQWdCLEVBQ2hCLFlBQVksR0FDYixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3JFLE9BQU8sRUFFTCx1Q0FBdUMsRUFDdkMsOEJBQThCLEVBQzlCLHdCQUF3QixHQUN6QixNQUFNLGtDQUFrQyxDQUFDO0FBQzFDLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQy9FLE9BQU8sRUFDTCxZQUFZLEVBQ1osZ0JBQWdCLEVBQ2hCLGFBQWEsRUFDYixPQUFPLEdBQ1IsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQUUsT0FBTyxFQUFXLElBQUksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNyRCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQU14RTs7OztHQUlHO0FBQ0gsTUFBTSxPQUFPLFdBQVc7SUFVSDtJQUNBO0lBVm5CLGdEQUFnRDtJQUNoRCxNQUFNLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztJQUVoQixTQUFTLENBQW1DO0lBRXBEOztPQUVHO0lBQ0gsWUFDbUIsS0FBZ0IsRUFDaEIsY0FBYyxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUs7UUFEL0IsVUFBSyxHQUFMLEtBQUssQ0FBVztRQUNoQixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFFaEQsSUFBSSxXQUFX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TSxHQUFHLGVBQWUsQ0FBQywyQkFBMkIsQ0FDeEQsZ0JBQWdCLENBQUMsT0FBTyxDQUN6QixDQUFDO1lBQ0YsZ0JBQWdCLENBQUMsZ0JBQWdCO2lCQUM5QixXQUFXLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDO2lCQUNsQyx5QkFBeUIsRUFBRTtpQkFDM0Isb0JBQW9CLENBQUMsTUFBTSxFQUFFLHFCQUFxQixDQUFDLENBQUM7UUFDekQsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDLENBQUM7Q0FDSDtBQUVELE1BQU0sNENBQTRDLEdBQ2hELDJCQUEyQixDQUFDO0FBRTlCOzs7R0FHRztBQUNILE1BQU0sdUNBQXVDO0lBQ3BDLEtBQUssQ0FBQyxLQUFpQjtRQUM1QixJQUFJLDJCQUEyQixDQUFDLDhCQUE4QixDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3JFLHFEQUFxRDtZQUNyRCx3REFBd0Q7WUFDeEQsS0FBSyxDQUFDLG1CQUFtQixDQUN2Qiw0Q0FBNEMsRUFDNUMsSUFBSSxDQUNMLENBQUM7U0FDSDtJQUNILENBQUM7Q0FDRjtBQUVEOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLENBQUMsS0FBZ0IsRUFBaUMsRUFBRSxDQUM1RSxJQUFJLFdBQVcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlGdW5jdGlvbixcbiAgQXV0aFJlc291cmNlcyxcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3IsXG4gIENvbnN0cnVjdEZhY3RvcnksXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIFJlc291cmNlUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQW1wbGlmeURhdGEsXG4gIEFtcGxpZnlEeW5hbW9EYlRhYmxlV3JhcHBlcixcbiAgSUFtcGxpZnlEYXRhRGVmaW5pdGlvbixcbiAgVHJhbnNsYXRpb25CZWhhdmlvcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RhdGEtY29uc3RydWN0JztcbmltcG9ydCB7IEdyYXBocWxPdXRwdXQgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQW1wbGlmeURhdGFFcnJvciwgRGF0YVByb3BzIH0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQge1xuICBjb21iaW5lQ0RLU2NoZW1hcyxcbiAgY29udmVydFNjaGVtYVRvQ0RLLFxuICBpc0NvbWJpbmVkU2NoZW1hLFxuICBpc0RhdGFTY2hlbWEsXG59IGZyb20gJy4vY29udmVydF9zY2hlbWEuanMnO1xuaW1wb3J0IHsgY29udmVydEZ1bmN0aW9uTmFtZU1hcFRvQ0RLIH0gZnJvbSAnLi9jb252ZXJ0X2Z1bmN0aW9ucy5qcyc7XG5pbXBvcnQge1xuICBQcm92aWRlZEF1dGhDb25maWcsXG4gIGJ1aWxkQ29uc3RydWN0RmFjdG9yeVByb3ZpZGVkQXV0aENvbmZpZyxcbiAgY29udmVydEF1dGhvcml6YXRpb25Nb2Rlc1RvQ0RLLFxuICBpc1VzaW5nRGVmYXVsdEFwaUtleUF1dGgsXG59IGZyb20gJy4vY29udmVydF9hdXRob3JpemF0aW9uX21vZGVzLmpzJztcbmltcG9ydCB7IHZhbGlkYXRlQXV0aG9yaXphdGlvbk1vZGVzIH0gZnJvbSAnLi92YWxpZGF0ZV9hdXRob3JpemF0aW9uX21vZGVzLmpzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlFcnJvcixcbiAgQW1wbGlmeVVzZXJFcnJvcixcbiAgQ0RLQ29udGV4dEtleSxcbiAgVGFnTmFtZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgQXNwZWN0cywgSUFzcGVjdCwgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IGNvbnZlcnRKc1Jlc29sdmVyRGVmaW5pdGlvbiB9IGZyb20gJy4vY29udmVydF9qc19yZXNvbHZlcnMuanMnO1xuaW1wb3J0IHsgQXBwU3luY1BvbGljeUdlbmVyYXRvciB9IGZyb20gJy4vYXBwX3N5bmNfcG9saWN5X2dlbmVyYXRvci5qcyc7XG5pbXBvcnQge1xuICBGdW5jdGlvblNjaGVtYUFjY2VzcyxcbiAgSnNSZXNvbHZlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RhdGEtc2NoZW1hLXR5cGVzJztcblxuLyoqXG4gKiBTaW5nbGV0b24gZmFjdG9yeSBmb3IgQW1wbGlmeUdyYXBocWxBcGkgY29uc3RydWN0cyB0aGF0IGNhbiBiZSB1c2VkIGluIEFtcGxpZnkgcHJvamVjdCBmaWxlcy5cbiAqXG4gKiBFeHBvcnRlZCBmb3IgdGVzdGluZyBwdXJwb3NlIG9ubHkgJiBzaG91bGQgTk9UIGJlIGV4cG9ydGVkIG91dCBvZiB0aGUgcGFja2FnZS5cbiAqL1xuZXhwb3J0IGNsYXNzIERhdGFGYWN0b3J5IGltcGxlbWVudHMgQ29uc3RydWN0RmFjdG9yeTxBbXBsaWZ5RGF0YT4ge1xuICAvLyBwdWJsaWNseSBhY2Nlc3NpYmxlIGZvciB0ZXN0aW5nIHB1cnBvc2Ugb25seS5cbiAgc3RhdGljIGZhY3RvcnlDb3VudCA9IDA7XG5cbiAgcHJpdmF0ZSBnZW5lcmF0b3I6IENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yO1xuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUNvbnN0cnVjdFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRGF0YVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgaW1wb3J0U3RhY2sgPSBuZXcgRXJyb3IoKS5zdGFja1xuICApIHtcbiAgICBpZiAoRGF0YUZhY3RvcnkuZmFjdG9yeUNvdW50ID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ011bHRpcGxlU2luZ2xldG9uUmVzb3VyY2VzRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgJ011bHRpcGxlIGBkZWZpbmVEYXRhYCBjYWxscyBhcmUgbm90IGFsbG93ZWQgd2l0aGluIGFuIEFtcGxpZnkgYmFja2VuZCcsXG4gICAgICAgIHJlc29sdXRpb246ICdSZW1vdmUgYWxsIGJ1dCBvbmUgYGRlZmluZURhdGFgIGNhbGwnLFxuICAgICAgfSk7XG4gICAgfVxuICAgIERhdGFGYWN0b3J5LmZhY3RvcnlDb3VudCsrO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYW4gaW5zdGFuY2Ugb2YgdGhlIERhdGEgY29uc3RydWN0XG4gICAqL1xuICBnZXRJbnN0YW5jZSA9IChwcm9wczogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMpOiBBbXBsaWZ5RGF0YSA9PiB7XG4gICAgY29uc3Qge1xuICAgICAgY29uc3RydWN0Q29udGFpbmVyLFxuICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICAgaW1wb3J0UGF0aFZlcmlmaWVyLFxuICAgICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yLFxuICAgIH0gPSBwcm9wcztcbiAgICBpbXBvcnRQYXRoVmVyaWZpZXI/LnZlcmlmeShcbiAgICAgIHRoaXMuaW1wb3J0U3RhY2ssXG4gICAgICBwYXRoLmpvaW4oJ2FtcGxpZnknLCAnZGF0YScsICdyZXNvdXJjZScpLFxuICAgICAgJ0FtcGxpZnkgRGF0YSBtdXN0IGJlIGRlZmluZWQgaW4gYW1wbGlmeS9kYXRhL3Jlc291cmNlLnRzJ1xuICAgICk7XG4gICAgaWYgKHRoaXMucHJvcHMubmFtZSkge1xuICAgICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPy52YWxpZGF0ZSh0aGlzLnByb3BzLm5hbWUpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuZ2VuZXJhdG9yKSB7XG4gICAgICB0aGlzLmdlbmVyYXRvciA9IG5ldyBEYXRhR2VuZXJhdG9yKFxuICAgICAgICB0aGlzLnByb3BzLFxuICAgICAgICBidWlsZENvbnN0cnVjdEZhY3RvcnlQcm92aWRlZEF1dGhDb25maWcoXG4gICAgICAgICAgcHJvcHMuY29uc3RydWN0Q29udGFpbmVyXG4gICAgICAgICAgICAuZ2V0Q29uc3RydWN0RmFjdG9yeTxSZXNvdXJjZVByb3ZpZGVyPEF1dGhSZXNvdXJjZXM+PihcbiAgICAgICAgICAgICAgJ0F1dGhSZXNvdXJjZXMnXG4gICAgICAgICAgICApXG4gICAgICAgICAgICA/LmdldEluc3RhbmNlKHByb3BzKVxuICAgICAgICApLFxuICAgICAgICBwcm9wcyxcbiAgICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5XG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gY29uc3RydWN0Q29udGFpbmVyLmdldE9yQ29tcHV0ZSh0aGlzLmdlbmVyYXRvcikgYXMgQW1wbGlmeURhdGE7XG4gIH07XG59XG5cbmNsYXNzIERhdGFHZW5lcmF0b3IgaW1wbGVtZW50cyBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvciB7XG4gIHJlYWRvbmx5IHJlc291cmNlR3JvdXBOYW1lID0gJ2RhdGEnO1xuICBwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBEYXRhUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm92aWRlZEF1dGhDb25maWc6IFByb3ZpZGVkQXV0aENvbmZpZyB8IHVuZGVmaW5lZCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEdyYXBocWxPdXRwdXQ+XG4gICkge1xuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWUgPz8gJ2FtcGxpZnlEYXRhJztcbiAgfVxuXG4gIGdlbmVyYXRlQ29udGFpbmVyRW50cnkgPSAoe1xuICAgIHNjb3BlLFxuICAgIHNzbUVudmlyb25tZW50RW50cmllc0dlbmVyYXRvcixcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgc3RhYmxlQmFja2VuZElkZW50aWZpZXJzLFxuICB9OiBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMpID0+IHtcbiAgICBjb25zdCBhbXBsaWZ5R3JhcGhxbERlZmluaXRpb25zOiBJQW1wbGlmeURhdGFEZWZpbml0aW9uW10gPSBbXTtcbiAgICBjb25zdCBzY2hlbWFzSnNGdW5jdGlvbnM6IEpzUmVzb2x2ZXJbXSA9IFtdO1xuICAgIGNvbnN0IHNjaGVtYXNGdW5jdGlvblNjaGVtYUFjY2VzczogRnVuY3Rpb25TY2hlbWFBY2Nlc3NbXSA9IFtdO1xuICAgIGxldCBzY2hlbWFzTGFtYmRhRnVuY3Rpb25zOiBSZWNvcmQ8XG4gICAgICBzdHJpbmcsXG4gICAgICBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlGdW5jdGlvbj5cbiAgICA+ID0ge307XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjaGVtYXMgPSBpc0NvbWJpbmVkU2NoZW1hKHRoaXMucHJvcHMuc2NoZW1hKVxuICAgICAgICA/IHRoaXMucHJvcHMuc2NoZW1hLnNjaGVtYXNcbiAgICAgICAgOiBbdGhpcy5wcm9wcy5zY2hlbWFdO1xuXG4gICAgICBzY2hlbWFzLmZvckVhY2goKHNjaGVtYSkgPT4ge1xuICAgICAgICBpZiAoaXNEYXRhU2NoZW1hKHNjaGVtYSkpIHtcbiAgICAgICAgICBjb25zdCB7IGpzRnVuY3Rpb25zLCBmdW5jdGlvblNjaGVtYUFjY2VzcywgbGFtYmRhRnVuY3Rpb25zIH0gPVxuICAgICAgICAgICAgc2NoZW1hLnRyYW5zZm9ybSgpO1xuICAgICAgICAgIHNjaGVtYXNKc0Z1bmN0aW9ucy5wdXNoKC4uLmpzRnVuY3Rpb25zKTtcbiAgICAgICAgICBzY2hlbWFzRnVuY3Rpb25TY2hlbWFBY2Nlc3MucHVzaCguLi5mdW5jdGlvblNjaGVtYUFjY2Vzcyk7XG4gICAgICAgICAgc2NoZW1hc0xhbWJkYUZ1bmN0aW9ucyA9IHtcbiAgICAgICAgICAgIC4uLnNjaGVtYXNMYW1iZGFGdW5jdGlvbnMsXG4gICAgICAgICAgICAuLi5sYW1iZGFGdW5jdGlvbnMsXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFtcGxpZnlHcmFwaHFsRGVmaW5pdGlvbnMucHVzaChcbiAgICAgICAgICBjb252ZXJ0U2NoZW1hVG9DREsoXG4gICAgICAgICAgICBzY2hlbWEsXG4gICAgICAgICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICAgICAgICBzdGFibGVCYWNrZW5kSWRlbnRpZmllcnNcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8QW1wbGlmeURhdGFFcnJvcj4oXG4gICAgICAgICdJbnZhbGlkU2NoZW1hRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICAgICAgICAgIDogJ0ZhaWxlZCB0byBwYXJzZSBzY2hlbWEgZGVmaW5pdGlvbi4nLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnQ2hlY2sgeW91ciBkYXRhIHNjaGVtYSBkZWZpbml0aW9uIGZvciBzeW50YXggYW5kIHR5cGUgZXJyb3JzLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IHVuZGVmaW5lZFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBsZXQgYXV0aG9yaXphdGlvbk1vZGVzO1xuICAgIHRyeSB7XG4gICAgICBhdXRob3JpemF0aW9uTW9kZXMgPSBjb252ZXJ0QXV0aG9yaXphdGlvbk1vZGVzVG9DREsoXG4gICAgICAgIHRoaXMuZ2V0SW5zdGFuY2VQcm9wcyxcbiAgICAgICAgdGhpcy5wcm92aWRlZEF1dGhDb25maWcsXG4gICAgICAgIHRoaXMucHJvcHMuYXV0aG9yaXphdGlvbk1vZGVzXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoQW1wbGlmeUVycm9yLmlzQW1wbGlmeUVycm9yKGVycm9yKSkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlEYXRhRXJyb3I+KFxuICAgICAgICAnSW52YWxpZFNjaGVtYUF1dGhFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuICAgICAgICAgICAgICA/IGVycm9yLm1lc3NhZ2VcbiAgICAgICAgICAgICAgOiAnRmFpbGVkIHRvIHBhcnNlIGF1dGhvcml6YXRpb24gbW9kZXMuJyxcbiAgICAgICAgICByZXNvbHV0aW9uOiAnRW5zdXJlIHRoZSBhdXRoIHJ1bGVzIG9uIHlvdXIgc2NoZW1hIGFyZSB2YWxpZC4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiB1bmRlZmluZWRcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlQXV0aG9yaXphdGlvbk1vZGVzKFxuICAgICAgICB0aGlzLnByb3BzLmF1dGhvcml6YXRpb25Nb2RlcyxcbiAgICAgICAgYXV0aG9yaXphdGlvbk1vZGVzXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxBbXBsaWZ5RGF0YUVycm9yPihcbiAgICAgICAgJ0ludmFsaWRTY2hlbWFBdXRoRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICAgICAgICAgIDogJ0ZhaWxlZCB0byB2YWxpZGF0ZSBhdXRob3JpemF0aW9uIG1vZGVzJyxcbiAgICAgICAgICByZXNvbHV0aW9uOiAnRW5zdXJlIHRoZSBhdXRoIHJ1bGVzIG9uIHlvdXIgc2NoZW1hIGFyZSB2YWxpZC4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiB1bmRlZmluZWRcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2FuZGJveE1vZGVFbmFibGVkID0gaXNVc2luZ0RlZmF1bHRBcGlLZXlBdXRoKFxuICAgICAgdGhpcy5wcm92aWRlZEF1dGhDb25maWcsXG4gICAgICB0aGlzLnByb3BzLmF1dGhvcml6YXRpb25Nb2Rlc1xuICAgICk7XG5cbiAgICBjb25zdCBwcm9wc0Z1bmN0aW9ucyA9IHRoaXMucHJvcHMuZnVuY3Rpb25zID8/IHt9O1xuXG4gICAgY29uc3QgZnVuY3Rpb25OYW1lTWFwID0gY29udmVydEZ1bmN0aW9uTmFtZU1hcFRvQ0RLKHRoaXMuZ2V0SW5zdGFuY2VQcm9wcywge1xuICAgICAgLi4ucHJvcHNGdW5jdGlvbnMsXG4gICAgICAuLi5zY2hlbWFzTGFtYmRhRnVuY3Rpb25zLFxuICAgIH0pO1xuICAgIGxldCBhbXBsaWZ5QXBpID0gdW5kZWZpbmVkO1xuXG4gICAgY29uc3QgaXNTYW5kYm94RGVwbG95bWVudCA9XG4gICAgICBzY29wZS5ub2RlLnRyeUdldENvbnRleHQoQ0RLQ29udGV4dEtleS5ERVBMT1lNRU5UX1RZUEUpID09PSAnc2FuZGJveCc7XG5cbiAgICB0cnkge1xuICAgICAgYW1wbGlmeUFwaSA9IG5ldyBBbXBsaWZ5RGF0YShzY29wZSwgdGhpcy5uYW1lLCB7XG4gICAgICAgIGFwaU5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgZGVmaW5pdGlvbjogY29tYmluZUNES1NjaGVtYXMoYW1wbGlmeUdyYXBocWxEZWZpbml0aW9ucyksXG4gICAgICAgIGF1dGhvcml6YXRpb25Nb2RlcyxcbiAgICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiB0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICAgICAgZnVuY3Rpb25OYW1lTWFwLFxuICAgICAgICB0cmFuc2xhdGlvbkJlaGF2aW9yOiB7XG4gICAgICAgICAgc2FuZGJveE1vZGVFbmFibGVkLFxuICAgICAgICAgIC8qKlxuICAgICAgICAgICAqIFRoZSBkZXN0cnVjdGl2ZSB1cGRhdGVzIHNob3VsZCBiZSBhbHdheXMgYWxsb3dlZCBpbiBiYWNrZW5kIGRlZmluaXRpb24gYW5kIG5vdCB0byBiZSBjb250cm9sbGVkIG9uIHRoZSBJYUNcbiAgICAgICAgICAgKiBUaGUgQ0kvQ0QgY2hlY2sgc2hvdWxkIHRha2UgdGhlIHJlc3BvbnNpYmlsaXR5IHRvIHZhbGlkYXRlIGlmIGFueSB0YWJsZXMgYXJlIGJlaW5nIHJlcGxhY2VkIGFuZCBkZXRlcm1pbmUgd2hldGhlciB0byBleGVjdXRlIHRoZSBjaGFuZ2VzZXRcbiAgICAgICAgICAgKi9cbiAgICAgICAgICBhbGxvd0Rlc3RydWN0aXZlR3JhcGhxbFNjaGVtYVVwZGF0ZXM6IHRydWUsXG4gICAgICAgICAgX3Byb3Zpc2lvbkhvdHN3YXBGcmllbmRseVJlc291cmNlczogaXNTYW5kYm94RGVwbG95bWVudCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0FtcGxpZnlEYXRhQ29uc3RydWN0SW5pdGlhbGl6YXRpb25FcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGluc3RhbnRpYXRlIGRhdGEgY29uc3RydWN0JyxcbiAgICAgICAgICByZXNvbHV0aW9uOiAnU2VlIHRoZSB1bmRlcmx5aW5nIGVycm9yIG1lc3NhZ2UgZm9yIG1vcmUgZGV0YWlscy4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBhcyBFcnJvclxuICAgICAgKTtcbiAgICB9XG5cbiAgICBUYWdzLm9mKGFtcGxpZnlBcGkpLmFkZChUYWdOYW1lLkZSSUVORExZX05BTUUsIHRoaXMubmFtZSk7XG5cbiAgICAvKio7XG4gICAgICogRW5hYmxlIHRoZSB0YWJsZSByZXBsYWNlbWVudCB1cG9uIEdTSSB1cGRhdGVcbiAgICAgKiBUaGlzIGlzIGFsbG93ZWQgaW4gc2FuZGJveCBtb2RlIE9OTFlcbiAgICAgKi9cbiAgICBpZiAoaXNTYW5kYm94RGVwbG95bWVudCkge1xuICAgICAgQXNwZWN0cy5vZihhbXBsaWZ5QXBpKS5hZGQobmV3IFJlcGxhY2VUYWJsZVVwb25Hc2lVcGRhdGVPdmVycmlkZUFzcGVjdCgpKTtcbiAgICB9XG5cbiAgICBjb252ZXJ0SnNSZXNvbHZlckRlZmluaXRpb24oc2NvcGUsIGFtcGxpZnlBcGksIHNjaGVtYXNKc0Z1bmN0aW9ucyk7XG5cbiAgICBjb25zdCBzc21FbnZpcm9ubWVudEVudHJpZXMgPVxuICAgICAgc3NtRW52aXJvbm1lbnRFbnRyaWVzR2VuZXJhdG9yLmdlbmVyYXRlU3NtRW52aXJvbm1lbnRFbnRyaWVzKHtcbiAgICAgICAgW2Ake3RoaXMubmFtZX1fR1JBUEhRTF9FTkRQT0lOVGBdOlxuICAgICAgICAgIGFtcGxpZnlBcGkucmVzb3VyY2VzLmNmblJlc291cmNlcy5jZm5HcmFwaHFsQXBpLmF0dHJHcmFwaFFsVXJsLFxuICAgICAgfSk7XG5cbiAgICBjb25zdCBwb2xpY3lHZW5lcmF0b3IgPSBuZXcgQXBwU3luY1BvbGljeUdlbmVyYXRvcihcbiAgICAgIGFtcGxpZnlBcGkucmVzb3VyY2VzLmdyYXBocWxBcGlcbiAgICApO1xuXG4gICAgc2NoZW1hc0Z1bmN0aW9uU2NoZW1hQWNjZXNzLmZvckVhY2goKGFjY2Vzc0RlZmluaXRpb24pID0+IHtcbiAgICAgIGNvbnN0IHBvbGljeSA9IHBvbGljeUdlbmVyYXRvci5nZW5lcmF0ZUdyYXBocWxBY2Nlc3NQb2xpY3koXG4gICAgICAgIGFjY2Vzc0RlZmluaXRpb24uYWN0aW9uc1xuICAgICAgKTtcbiAgICAgIGFjY2Vzc0RlZmluaXRpb24ucmVzb3VyY2VQcm92aWRlclxuICAgICAgICAuZ2V0SW5zdGFuY2UodGhpcy5nZXRJbnN0YW5jZVByb3BzKVxuICAgICAgICAuZ2V0UmVzb3VyY2VBY2Nlc3NBY2NlcHRvcigpXG4gICAgICAgIC5hY2NlcHRSZXNvdXJjZUFjY2Vzcyhwb2xpY3ksIHNzbUVudmlyb25tZW50RW50cmllcyk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYW1wbGlmeUFwaTtcbiAgfTtcbn1cblxuY29uc3QgUkVQTEFDRV9UQUJMRV9VUE9OX0dTSV9VUERBVEVfQVRUUklCVVRFX05BTUU6IGtleW9mIFRyYW5zbGF0aW9uQmVoYXZpb3IgPVxuICAncmVwbGFjZVRhYmxlVXBvbkdzaVVwZGF0ZSc7XG5cbi8qKlxuICogQXNwZWN0IGNsYXNzIHRvIG1vZGlmeSB0aGUgYW1wbGlmeSBtYW5hZ2VkIER5bmFtb0RCIHRhYmxlXG4gKiB0byBhbGxvdyB0YWJsZSByZXBsYWNlbWVudCB1cG9uIEdTSSB1cGRhdGVcbiAqL1xuY2xhc3MgUmVwbGFjZVRhYmxlVXBvbkdzaVVwZGF0ZU92ZXJyaWRlQXNwZWN0IGltcGxlbWVudHMgSUFzcGVjdCB7XG4gIHB1YmxpYyB2aXNpdChzY29wZTogSUNvbnN0cnVjdCk6IHZvaWQge1xuICAgIGlmIChBbXBsaWZ5RHluYW1vRGJUYWJsZVdyYXBwZXIuaXNBbXBsaWZ5RHluYW1vRGJUYWJsZVJlc291cmNlKHNjb3BlKSkge1xuICAgICAgLy8gVGhlc2UgdmFsdWUgc2V0dGVycyBhcmUgbm90IGV4cG9zZWQgaW4gdGhlIHdyYXBwZXJcbiAgICAgIC8vIE5lZWQgdG8gdXNlIHRoZSBwcm9wZXJ0eSBvdmVycmlkZSB0byBlc2NhcGUgdGhlIGhhdGNoXG4gICAgICBzY29wZS5hZGRQcm9wZXJ0eU92ZXJyaWRlKFxuICAgICAgICBSRVBMQUNFX1RBQkxFX1VQT05fR1NJX1VQREFURV9BVFRSSUJVVEVfTkFNRSxcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGVzIGEgZmFjdG9yeSB0aGF0IGltcGxlbWVudHMgQ29uc3RydWN0RmFjdG9yeTxBbXBsaWZ5R3JhcGhxbEFwaT5cbiAqL1xuZXhwb3J0IGNvbnN0IGRlZmluZURhdGEgPSAocHJvcHM6IERhdGFQcm9wcyk6IENvbnN0cnVjdEZhY3Rvcnk8QW1wbGlmeURhdGE+ID0+XG4gIG5ldyBEYXRhRmFjdG9yeShwcm9wcywgbmV3IEVycm9yKCkuc3RhY2spO1xuIl19